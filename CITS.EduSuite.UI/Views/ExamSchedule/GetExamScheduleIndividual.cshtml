@model CITS.EduSuite.Business.Models.ViewModels.ExamScheduleViewModel
@using CITS.EduSuite.Business.Models.ViewModels


@Html.HiddenFor(m => m.IsMultipleExamSchedule)
<div id="dynamicRepeater" class="repeater">
    <table class="table table-responsive">
        <thead>
            <tr>
                <th></th>
                <th>
                    @Html.Label(EduSuiteUIResources.Status, htmlAttributes: new { @class = "form-label" })
                    <div class="checkbox-bird green inline-block mt-2">
                        @Html.CheckBox("chekAll", new { @InputFor = "lblIsOriginal", @class = "custom-control-input", @onchange = "CheckboxAllChange(this, 'IsActive')" })
                        <label for="chekAll" class="label-for-check form-label">
                        </label>
                    </div>
                    <span id="CheckedAllCount"></span>
                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.SubjectName, htmlAttributes: new { @class = "form-label" })
                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.Subject + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.Year, htmlAttributes: new { @class = "form-label" })
                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.AppearanceCount, htmlAttributes: new { @class = "form-label" })
                </th>

                <th>
                    @Html.Label(EduSuiteUIResources.ExamDate, htmlAttributes: new { @class = "form-label" })
                    @Html.TextBoxFor(m => m.ExamDate, "{0:dd/MM/yyyy}", new { @class = "form-control input-control", @data_input_type = "date", @data_inputmask = "'alias': 'dd/mm/yyyy'", @onchange = "ChangeExamDateAll(this)" })


                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.ExamCentre, htmlAttributes: new { @class = "form-label" })
                    @Html.DropDownListFor(m => m.ExamCenterKeyAll, new SelectList(Model.ExamCenter, "RowKey", "Text"), EduSuiteUIResources.Select + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.ExamCentre, new { @class = "form-control border-radius input-control autoselect-select", @onchange = "ChangeExamCenterAll(this)" })
                </th>
                @*<th>
                        @Html.Label(EduSuiteUIResources.ExamTerm, htmlAttributes: new { @class = "form-label" })
                        @Html.DropDownListFor(m => m.ExamTermKeyAll, new SelectList(Model.ExamTerm, "RowKey", "Text"), EduSuiteUIResources.Select + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.ExamTerm, new { @class = "form-control border-radius input-control autoselect-select", @onchange = "ChangeExamTerm(this)" })
                    </th>*@
                <th>
                    @Html.Label(EduSuiteUIResources.MinimumMark, htmlAttributes: new { @class = "form-label" })
                    @Html.TextBoxFor(m => m.MinimumMark, new { @class = "form-control input-control", @oninput = "ChangeMinimumMarkAll(this)" })
                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.MaximumMark, htmlAttributes: new { @class = "form-label" })
                    @Html.TextBoxFor(m => m.MaximumMark, new { @class = "form-control input-control", @oninput = "ChangeMaximumMarkAll(this)" })
                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.StartTime, htmlAttributes: new { @class = "form-label" })
                    @Html.TextBoxFor(m => m.ExamStartTime, new { @class = "form-control input-control", @data_input_type = "time", @data_inputmask = "'alias':'hh:mm t','hourFormat': '12'", @InputFor = "lblCallDuration",@oninput = "ChangeStarTimeAll(this)" })
                </th>
                <th>
                    @Html.Label(EduSuiteUIResources.EndTime, htmlAttributes: new { @class = "form-label" })
                    @Html.TextBoxFor(m => m.ExamEndTime, new { @class = "form-control input-control", @data_input_type = "time", @data_inputmask = "'alias':'hh:mm t','hourFormat': '12'", @InputFor = "lblCallDuration",@oninput = "ChangeEndTimeAll(this)" })
                </th>
            </tr>
        </thead>
        <tbody data-repeater-list>
            @for (int i = 0; i < Model.ExamScheduleDetailsModel.Count(); i++)
            {
                <tr data-repeater-item>
                    <td class="px-1">
                        @if (Model.ExamScheduleDetailsModel[i].RowKey != null && Model.ExamScheduleDetailsModel[i].RowKey != 0)
                        {
                            <span onclick="ExamSchedule.ResetExamSchedule(@Model.ExamScheduleDetailsModel[i].RowKey,false)" class="btn btn-danger btn-sm btnDeleteRow">
                                <span class="fa fa-remove"></span>
                            </span>
                        }
                    </td>
                    <td class="px-1">
                        <div class="switch-check my-2">
                            @Html.CheckBoxFor(m => m.ExamScheduleDetailsModel[i].IsActive, new { @class = "switch-input chkIsActive", @onchange = "SetMinMaxMark(this)" })
                            <div class="switch-label yesno" data-on="@EduSuiteUIResources.Yes" data-off="@EduSuiteUIResources.No"></div>
                            <div class="switch-handle"></div>
                        </div>
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].IsActive)
                        </span>
                    </td>
                    <td class="px-1">
                        @Html.DisplayFor(m => m.ExamScheduleDetailsModel[i].SubjectName, new { @class = "form-control input-control" })
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ApplicationKey)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].RowKey)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].SubjectKey)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ExamRegisterNumber)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ExamTermKey)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ExamStatus)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].SubjectName)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ExamTermName)
                        @*@Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].IsActive)*@
                    </td>
                    <td class="px-1">
                        @Html.DisplayFor(m => m.ExamScheduleDetailsModel[i].SubjectYearName, new { @class = "form-control input-control" })
                    </td>
                    <td class="px-1">
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].AppearenceCount)
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ExamAttempName)
                        @Html.TextBoxFor(m => m.ExamScheduleDetailsModel[i].AppearenceCountText, new { @class = "form-control input-control", @readonly = "readonly" })
                    </td>

                    <td class="px-1">
                        @Html.TextBoxFor(m => m.ExamScheduleDetailsModel[i].ExamDate, "{0:dd/MM/yyyy}", new { @class = "form-control input-control", @data_input_type = "date", @data_inputmask = "'alias': 'dd/mm/yyyy'" })
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].ExamDate)
                        </span>
                    </td>
                    <td class="px-1">
                        @Html.DropDownListFor(m => m.ExamScheduleDetailsModel[i].ExamCenterKey, new SelectList(Model.ExamCenter, "RowKey", "Text", Model.ExamScheduleDetailsModel[i].ExamCenterKey), EduSuiteUIResources.Select + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.ExamCentre, new { @class = "form-control border-radius input-control autoselect-select", @onchange = "GetExamCenterName(this)" })
                        @Html.HiddenFor(m => m.ExamScheduleDetailsModel[i].ExamCenterName)
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].ExamCenterKey)
                        </span>
                    </td>
                    @*<td class="px-1">
                            @Html.DropDownListFor(m => m.ExamScheduleDetailsModel[i].ExamTermKey, new SelectList(Model.ExamScheduleDetailsModel[i].ExamTerm, "RowKey", "Text"), EduSuiteUIResources.Select + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.ExamTerm, new { @class = "form-control border-radius input-control autoselect-select" })
                            <span class="form-control-error-text">
                                @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].ExamTermKey)
                            </span>
                        </td>*@
                    <td class="px-1">
                        @Html.TextBoxFor(m => m.ExamScheduleDetailsModel[i].MinimumMark, new { @class = "form-control input-control" })
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].MinimumMark)
                        </span>
                    </td>
                    <td class="px-1">
                        @Html.TextBoxFor(m => m.ExamScheduleDetailsModel[i].MaximumMark, new { @class = "form-control input-control" })
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].MaximumMark)
                        </span>
                    </td>
                    <td class="px-1">
                        @Html.TextBoxFor(m => m.ExamScheduleDetailsModel[i].ExamStartTime, new { @class = "form-control input-control", @data_input_type = "time", @data_inputmask = "'alias':'hh:mm t','hourFormat': '12'", @InputFor = "lblCallDuration" })
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].ExamStartTime)
                        </span>
                    </td>
                    <td class="px-1">
                        @Html.TextBoxFor(m => m.ExamScheduleDetailsModel[i].ExamEndTime, new { @class = "form-control input-control", @data_input_type = "time", @data_inputmask = "'alias':'hh:mm t','hourFormat': '12'", @InputFor = "lblCallDuration" })
                        <span class="form-control-error-text">
                            @Html.ValidationMessageFor(m => m.ExamScheduleDetailsModel[i].ExamEndTime)
                        </span>
                    </td>

                </tr>
            }
        </tbody>
    </table>
</div>


<script>
    $(document).ready(function () {
        @*$("#RowKey").val(@Model.RowKey)*@
        $("#ExamStartTime").val('@Model.ExamStartTime')
        $("#ExamEndTime").val('@Model.ExamEndTime')
        $("#MaximumMark").val(@Model.MaximumMark)
        $("#MinimumMark").val(@Model.MinimumMark)
        $("#ExamDate").val('@Model.ExamDate')




        AppCommon.FormatDateInput();
        AppCommon.FormatInputCase();
        AppCommon.FormatTimeInput();
        $("form").removeData("validator");
        $("form").removeData("unobtrusiveValidation");
        $.validator.unobtrusive.parse("form");


        $("[data-repeater-item]").each(function (Index) {

            var CheckedList = $("input[type=checkbox][name*=IsActive]:checked");
            var CheckedListCount = $("input[type=checkbox][name*=IsActive]:checked").length;


            $(CheckedList).each(function () {
                $(this).prop("disabled", true);
            });

            var AppearenceCount = $("input[id*=AppearenceCount]", $(this)).val();
            var ExamAttempName = $("input[id*=ExamAttempName]", $(this)).val();
            var Appearncetext = getNumberWithOrdinal(AppearenceCount);

            if (ExamAttempName != "") {
                $("input[id*=AppearenceCountText]", $(this)).val(Appearncetext + " (" + ExamAttempName + ")");
            }
            else {
                $("input[id*=AppearenceCountText]", $(this)).val(Appearncetext);
            }

        });



        $(".chkIsActive").change(function () {
            StudentsCheckedCount();
        });


    });

    function GetExamCenterName(_this) {
        
        var item = $(_this).closest("[data-repeater-item]");
        var CenterName = $(_this).find('option:selected').text();
        $("input[id*=ExamCenterName]", $(item)).val($(_this).find('option:selected').text());
    }



    function CheckboxAllChange(chk, name) {
        
        $("[data-repeater-item]").each(function (index) {

            var Object = $('input[name*=' + name + ']', $(this))[0];
            if (Object != undefined) {
                if (!Object.disabled) {
                    Object.checked = chk.checked
                    SetMinMaxMark(Object);
                }
            }
        });
        StudentsCheckedCount();
    }


    function StudentsCheckedCount() {
        
        var CheckedCount = $("input[type=checkbox][name*=IsActive]:checked").length;
        var CheckboxCount = $("input[type=checkbox][name*=IsActive]").length;
        var CheckedAll = false;
        if (parseInt(CheckboxCount) == parseInt(CheckedCount)) {
            CheckedAll = true;
        }
        $("#CheckedAllCount").html("");
        $("#NoOfStudents").val("");
        if (CheckedCount != 0) {
            $("#CheckedAllCount").html("(" + CheckedCount + ")");
            $("#NoOfStudents").val(CheckedCount);

            if (CheckedAll == true) {
                $("#chekAll").prop("checked", true);
            }
            else {
                $("#chekAll").prop("checked", false);
            }
        }
    }
    function ChangeMinimumMarkAll(_this) {

        var MinimumMark = $(_this).val() != "" ? $(_this).val() : 0;

        $("#dvStudentsList [data-repeater-item]").each(function (i) {
            var item = $(this).closest("[data-repeater-item]");
            var object = $("input[type=checkbox][name*=IsActive]", $(item))[0];
            if (object.checked)
                $("input[name*=MinimumMark]", $(item)).val(MinimumMark)

        });
    };

    function ChangeMaximumMarkAll(_this) {

        var MaximumMark = $(_this).val() != "" ? $(_this).val() : 0;

        $("#dvStudentsList [data-repeater-item]").each(function (i) {
            var item = $(this).closest("[data-repeater-item]");
            var object = $("input[type=checkbox][name*=IsActive]", $(item))[0];
            if (object.checked)
                $("input[name*=MaximumMark]", $(item)).val(MaximumMark)
        });
    }
    function ChangeStarTimeAll(_this) {

        var StartTime = $(_this).val() != "" ? $(_this).val() : 0;

        $("#dvStudentsList [data-repeater-item]").each(function (i) {
            var item = $(this).closest("[data-repeater-item]");
            var object = $("input[type=checkbox][name*=IsActive]", $(item))[0];
            if (object.checked)
                $("input[name*=ExamStartTime]", $(item)).val(StartTime)
        });
    }
    function ChangeEndTimeAll(_this) {

        var EndTime = $(_this).val() != "" ? $(_this).val() : 0;

        $("#dvStudentsList [data-repeater-item]").each(function (i) {
            var item = $(this).closest("[data-repeater-item]");
            var object = $("input[type=checkbox][name*=IsActive]", $(item))[0];
            if (object.checked)
                $("input[name*=ExamEndTime]", $(item)).val(EndTime)
        });
    }
    function SetMinMaxMark(_this) {
        var MinimumMarkAll = $("#MinimumMark").val();
        var MaximumMarkAll = $("#MaximumMark").val();
        MinimumMarkAll = parseFloat(MinimumMarkAll) ? parseFloat(MinimumMarkAll) : null;
        MaximumMarkAll = parseFloat(MaximumMarkAll) ? parseFloat(MaximumMarkAll) : null;

        var item = $(_this).closest("[data-repeater-item]");
        if (_this.checked) {
            $("input[name*=MinimumMark]", $(item)).val(MinimumMarkAll)
            $("input[name*=MaximumMark]", $(item)).val(MaximumMarkAll)
        }
        else {
            $("input[name*=MinimumMark]", $(item)).val("")
            $("input[name*=MaximumMark]", $(item)).val("")
        }

    }

    function ChangeExamCenterAll(_this) {
        var ExamCenterKeyAll = $(_this).val() != "" ? $(_this).val() : 0;

        $("#dvStudentsList [data-repeater-item]").each(function (i) {
            var item = $(this).closest("[data-repeater-item]");
            var object = $("input[type=checkbox][name*=IsActive]", $(item))[0];
            if (object.checked) {
                $("select[name*=ExamCenterKey]", $(item)).val(ExamCenterKeyAll)
                $("input[id*=ExamCenterName]", $(item)).val($(_this).find('option:selected').text());
            }
        });
    }

    function ChangeExamDateAll(_this) {

        var ExamDate = $(_this).val() != "" ? $(_this).val() : 0;

        $("#dvStudentsList [data-repeater-item]").each(function (i) {
            var item = $(this).closest("[data-repeater-item]");
            $("input[name*=ExamDate]", $(item)).val(ExamDate)
        });
    };

    function getNumberWithOrdinal(n) {
        var s = ["th", "st", "nd", "rd"],
        v = n % 100;
        return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

</script>
