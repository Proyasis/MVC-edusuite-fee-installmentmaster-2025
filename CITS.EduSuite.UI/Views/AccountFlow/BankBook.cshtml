@model CITS.EduSuite.Business.Models.ViewModels.AccountFlowViewModel
@using CITS.EduSuite.Business.Models.ViewModels

@section scripts{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/Content/DatePickerJS")

    @*@Scripts.Render("~/Scripts/AccountHead")*@
}
@{
    ViewBag.Title = EduSuiteUIResources.BankBook;
}


@Html.AntiForgeryToken()
@Html.HiddenFor(m => m.RowKey)
@Html.ValidationSummary(true)

<input type="hidden" id="hdnBindLedgerById" value="@Url.Action("BindLedgerById", "AccountFlow")" />
<input type="hidden" id="hdnFillBanksById" value="@Url.Action("FillBanks", "AccountFlow")" />

<header class="section-header">
    <div class="row justify-content-between px-1">
        <div class="col-12">
            <div class="tbl">
                <div class="tbl-row">
                    <div class="tbl-cell">
                        <h3>@EduSuiteUIResources.BankBook</h3>

                    </div>
                </div>
            </div>
        </div>

    </div>
</header>
<section class="section-content mx-sm-3 mx-0">
    <div class="ledgerTable">
        <form id="frmBankBook">
            <div class="grid-nav-bar">
                <div class="form-row">
                    <div class="col-lg-2 col-sm-3 col-6">
                        <div class="form-group">
                            @Html.Label(EduSuiteUIResources.FromDate, htmlAttributes: new { @class = "form-label" })
                            @Html.TextBoxFor(m => m.FromDate, "{0:dd/MM/yyyy}", new { @class = "form-control", @data_inputmask = "'alias': 'dd/mm/yyyy'", @data_input_type = "date" })
                            <span class="form-control-error-text">
                                @Html.ValidationMessageFor(m => m.FromDate)
                            </span>
                        </div>
                    </div>
                    <div class="col-lg-2 col-sm-3 col-6">
                        <div class="form-group ">
                            @Html.Label(EduSuiteUIResources.ToDate, htmlAttributes: new { @class = "form-label" })
                            @Html.TextBoxFor(m => m.ToDate, "{0:dd/MM/yyyy}", new { @class = "form-control", @data_inputmask = "'alias': 'dd/mm/yyyy'", @data_input_type = "date" })
                            <span class="form-control-error-text">
                                @Html.ValidationMessageFor(m => m.ToDate)
                            </span>
                        </div>
                    </div>

                    @if (Model.Branches.Count == 1)
                    {
                        {
                            Model.BranchKey = (Model.BranchKey == 0 || Model.BranchKey == null) ? (short)Model.Branches.Select(x => x.RowKey).FirstOrDefault() : Model.BranchKey;
                        }
                        @Html.HiddenFor(m => m.BranchKey)
                    }
                    else
                    {
                        if (DbConstants.Role.AdminUserTypes.Contains(DbConstants.User.RoleKey))
                        {
                            <div class="col-12 col-sm-3 col-lg-2">
                                <fieldset class="form-group">
                                    @Html.Label(EduSuiteUIResources.Branch, htmlAttributes: new { @class = "form-label" })
                                    @Html.DropDownListFor(m => m.BranchKey, new SelectList(Model.Branches, "RowKey", "Text"), EduSuiteUIResources.Select + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.Branch, new { @class = "form-control input-control", @InputFor = "lblBranch", @data_live_search = "true" })
                                    <span class="form-control-error-text">
                                        @Html.ValidationMessageFor(m => m.BranchKey)
                                    </span>
                                </fieldset>
                            </div>
                        }
                        else
                        {
                            <div class="col-12 col-sm-3 col-lg-2">
                                <fieldset class="form-group">
                                    @Html.Label(EduSuiteUIResources.Branch, htmlAttributes: new { @class = "form-label" })
                                    @Html.DropDownListFor(m => m.BranchKey, new SelectList(Model.Branches, "RowKey", "Text"), new { @class = "form-control input-control", @InputFor = "lblBranch", @data_live_search = "true" })
                                    <span class="form-control-error-text">
                                        @Html.ValidationMessageFor(m => m.BranchKey)
                                    </span>
                                </fieldset>
                            </div>
                        }
                    }






                    <div class="col-lg-2 col-sm-3 col-5">
                        <div class="form-group">
                            @Html.Label(EduSuiteUIResources.BankAccount, htmlAttributes: new { @class = "form-label" })
                            <div class="required-icon"><div class="text">*</div></div>
                            @Html.DropDownListFor(m => m.AccountHeadKey, new SelectList(Model.BankAccounts, "Message", "Text"), EduSuiteUIResources.Select + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.BankAccount, new { @class = "form-control input-control ", @data_live_search = "true" })
                            <span class="form-control-error-text">
                                @Html.ValidationMessageFor(m => m.AccountHeadKey)
                            </span>
                        </div>
                    </div>



                    <div class="col-sm-2 form-col">
                        <div class="form-group text-center">
                            @Html.Label(EduSuiteUIResources.Period + EduSuiteUIResources.BlankSpace + EduSuiteUIResources.On, htmlAttributes: new { @class = "form-label", @style = "margin-bottom: 7px;margin-top: 6px;" })
                            @Html.CheckBox("PeriodOnly", false, new { @class = "flex-checkbox" })
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="form-group">
                            <br />
                            <input type="button" value="@EduSuiteUIResources.View" id="btnView" class="btn btn-sm btn-success mt-1 float-right " />
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-12">
                        <div class="button-group float-right">
                            <button id="btnPrint" type="button" class="btn btn-primary btn-sm"><i class="fa fa-print btn-blue" aria-hidden="true"></i></button>
                            <button id="btnExport" type="button" class="btn btn-success btn-sm"><i class="fa fa-file-excel-o fa-align-right" aria-hidden="true"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="table-wrapper">

            <div id="BankBookList" class="jqGrid_wrapper overflow-auto">

            </div>
        </div>
    </div>
</section>


<script>
    $(document).ready(function () {
        AppCommon.FormatDateInput();
        AppCommon.FormatInputCase();
        $("#btnView").on("click", function () {
            var valid = $("#frmBankBook").valid()
            if (valid) {
                LoadReport();
            }
        });

        BindBank();
        $("#BranchKey").change(function () {
            BindBank();
        });

        LoadReport();


        //Export To Excel
        var obj = { HtmlCntrl: $("#BankBookList") };
        $("#btnExport").on("click", function () {
            obj.ContainerId = $('#BankBookTable'),
            setExportTitle(obj)
            AppCommon.ExportTableToExcel(obj);
        });
        $("#btnPrint").on("click", function () {
            obj.ContainerId = $('#BankBookTable'),
            setExportTitle(obj)
            AppCommon.PrintHtml(obj);
        });

    });
    function setExportTitle(obj) {
        obj.Title = '@EduSuiteUIResources.BankBook' + ' - ' + $("#AccountHeadKey").find("option:selected").text();
        obj.SubTitle = $("#FromDate").val() === $("#ToDate").val() ? $("#FromDate").val() : $("#FromDate").val() + " - " + $("#ToDate").val();
        obj.FileName = (obj.Title + "_" + obj.SubTitle).replace(/-/g, '_')
    }

    function LoadReport() {
        
        //var BankAccountCode = $("#BankAccountCode");
        var obj = {};
        obj.id = $("#AccountHeadKey").val()
        obj.fromDate = $("#FromDate").val()
        obj.toDate = $("#ToDate").val()
        //obj.accountHeadCode = $("#AccoundHeadKey").val()
        obj.BranchKey = $("#BranchKey").val()
        obj.appUserKey = $("#AppUserKey").val()
        obj.periodOnly = $("input[type=checkbox][name*=PeriodOnly]").prop("checked"),


        $(".section-content").mLoading()
        $("#BankBookList").load($("#hdnBindLedgerById").val() + "?" + $.param(obj), function () {
            $(".section-content").mLoading("destroy")
        })

    }

    function BindBank() {
        var obj = {};
        obj.branchkey = $("#BranchKey").val() != "" ? $("#BranchKey").val() : 0;
        AppCommon.BindDropDownbyId(obj, $("#hdnFillBanksById").val(), $("#AccountHeadKey"), Resources.BankAccount);
        

        //$ddl = $("#BankAccountCode");
       
        //var branchkeyValue = $("#BranchKey").val();
        //branchkeyValue = parseInt(branchkeyValue) ? parseInt(branchkeyValue) : 0;
        //$.ajax({
        //    url: $("#hdnFillBanksById").val(),
        //    type: "GET",
        //    dataType: "JSON",
        //    data: { branchkey: branchkeyValue },
        //    success: function (result) {
        //        $ddl.html(""); // clear before appending new list
        //        $ddl.append($('<option></option>').val("").html(Resources.Select + Resources.BlankSpace + Resources.BankAccount));
        //        if (result.length>0) {
        //            $.each(result, function (i, BankAccount) {
        //                $ddl.append(
        //                    $('<option></option>').val(BankAccount.Message).html(BankAccount.Text));
        //            });
        //            $ddl.selectpicker('refresh');
        //        }
        //        else {
        //            $ddl.html(""); // clear before appending new list
        //            $ddl.selectpicker('refresh');
        //            $ddl.trigger("change");
        //            $ddl.append($('<option></option>').val("").html(Resources.Select + Resources.BlankSpace + Resources.BankAccount));
        //        }
        //    }
        //});


    }
</script>


